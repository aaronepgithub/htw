<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hold the Wheel!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      touch-action: none;
    }
    .hud-stat {
      font-family: 'Bangers', cursive;
      letter-spacing: 1px;
    }
    .surge-effect {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      animation: surge-flash 0.3s ease-out;
    }
    @keyframes surge-flash {
      0%, 100% { opacity: 0; }
      25% { opacity: 0.8; }
    }
    /* Custom slider styles */
    input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        cursor: pointer;
        outline: none;
        border-radius: 9999px;
        height: 1.25rem;
        background: #374151; /* gray-700 */
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        height: 2.25rem;
        width: 2.25rem;
        background-color: #f59e0b; /* amber-500 */
        border-radius: 9999px;
        border: 4px solid white;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    input[type=range]::-moz-range-thumb {
        height: 2.25rem;
        width: 2.25rem;
        background-color: #f59e0b; /* amber-500 */
        border-radius: 9999px;
        border: 4px solid white;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen justify-center items-center p-2 sm:p-4">

  <div id="game-container" class="w-full max-w-4xl mx-auto">
    <!-- HUD -->
    <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-4 p-3 bg-gray-800/80 rounded-t-xl text-center border-b-4 border-amber-500">
      <div class="hud-stat"><span class="text-amber-400 text-lg">Power</span><br><span id="powerOut" class="text-2xl">180</span> W</div>
      <div class="hud-stat"><span class="text-amber-400 text-lg">Speed</span><br><span id="speedOut" class="text-2xl">0.0</span> km/h</div>
      <div class="hud-stat"><span class="text-red-400 text-lg">Villain</span><br><span id="villName" class="text-2xl">None</span></div>
      <div class="hud-stat hidden sm:block"><span class="text-blue-400 text-lg">Gap</span><br><span id="gapOut" class="text-2xl">â€”</span></div>
      <div class="hud-stat"><span class="text-green-400 text-lg">Score</span><br><span id="scoreOut" class="text-2xl">0</span></div>
    </div>

    <!-- Canvas -->
    <canvas id="gameCanvas" class="w-full h-auto aspect-[3/1] bg-gray-900 rounded-b-xl"></canvas>
    
    <!-- Controls -->
    <div class="p-4 bg-gray-800/80 rounded-xl mt-4 text-center">
        <div class="flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#f59e0b" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm48-88a48,48,0,1,1-48-48A48.05,48.05,0,0,1,176,128Z"></path></svg>
            <input id="powerSlider" type="range" min="50" max="800" value="180"/>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#f59e0b" viewBox="0 0 256 256"><path d="M168,40a96.1,96.1,0,0,0-85.35,50.2L52,70.51A104,104,0,1,1,42.42,152H64a80,80,0,1,0,7.38-32H96a56,56,0,1,1,50.62,29.32L128,172a24,24,0,1,0,24-24h16a40,40,0,1,1-35.35-21.32L144,148a8,8,0,0,0,16,0l-12.27-24.53A79.54,79.54,0,0,0,168,120a80,80,0,0,0-79.37-72H112a56,56,0,0,1,50.31-27.23A56.53,56.53,0,0,1,168,24a56,56,0,0,1,56,56H200a80,80,0,0,0-32-64ZM128,200a72,72,0,1,1,72-72A72.08,72.08,0,0,1,128,200Z"></path></svg>
        </div>
        <button id="startBtn" class="mt-4 px-8 py-3 bg-amber-500 text-gray-900 font-bold rounded-lg text-xl shadow-lg hover:bg-amber-400 transition-all transform hover:scale-105">Start Ride</button>
    </div>
  </div>

  <div id="surge-container"></div>
  
  <script>
    // --- Asset Generation ---
    const SVG_ASSETS = {
        hero: {
            base: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4)"><path d="M32 30 C 40 18, 48 22, 48 30 L 44 48 L 20 48 L 16 30 C 16 22, 24 18, 32 30" fill="#3b82f6"/><path d="M32,16 a8,8 0 1,1 0,16 a8,8 0 1,1 0,-16" fill="#fde047"/><circle cx="20" cy="56" r="6" fill="#374151" stroke="#e5e7eb" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#374151" stroke="#e5e7eb" stroke-width="2"/><line x1="20" y1="56" x2="32" y2="42" stroke="#e5e7eb" stroke-width="2"/><line x1="44" y1="56" x2="32" y2="42" stroke="#e5e7eb" stroke-width="2"/></g></svg>`,
            surge: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(-10 32 32)"><path d="M32 30 C 40 18, 48 22, 48 30 L 44 48 L 20 48 L 16 30 C 16 22, 24 18, 32 30" fill="#2563eb"/><path d="M32,16 a8,8 0 1,1 0,16 a8,8 0 1,1 0,-16" fill="#fef08a"/><circle cx="20" cy="56" r="6" fill="#374151" stroke="#e5e7eb" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#374151" stroke="#e5e7eb" stroke-width="2"/><line x1="20" y1="56" x2="32" y2="42" stroke="#e5e7eb" stroke-width="2"/><line x1="44" y1="56" x2="32" y2="42" stroke="#e5e7eb" stroke-width="2"/></g></svg>`
        },
        rouleur: {
            base: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4)"><path d="M32 28 C 44 18, 52 24, 52 32 L 48 50 L 16 50 L 12 32 C 12 24, 20 18, 32 28" fill="#ef4444"/><path d="M32,14 a9,9 0 1,1 0,18 a9,9 0 1,1 0,-18" fill="#d1d5db"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/></g></svg>`,
            surge: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(-5 32 32)"><path d="M32 28 C 44 18, 52 24, 52 32 L 48 50 L 16 50 L 12 32 C 12 24, 20 18, 32 28" fill="#dc2626"/><path d="M32,14 a9,9 0 1,1 0,18 a9,9 0 1,1 0,-18" fill="#f9fafb"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#ef4444" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#ef4444" stroke-width="2"/></g></svg>`
        },
        climber: {
            base: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(15 32 32)"><path d="M32 32 C 38 22, 44 26, 44 32 L 40 50 L 24 50 L 20 32 C 20 26, 26 22, 32 32" fill="#22c55e"/><path d="M32,18 a7,7 0 1,1 0,14 a7,7 0 1,1 0,-14" fill="#d1d5db"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/></g></svg>`,
            surge: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(20 32 32)"><path d="M32 32 C 38 22, 44 26, 44 32 L 40 50 L 24 50 L 20 32 C 20 26, 26 22, 32 32" fill="#16a34a"/><path d="M32,18 a7,7 0 1,1 0,14 a7,7 0 1,1 0,-14" fill="#f9fafb"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#22c55e" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#22c55e" stroke-width="2"/></g></svg>`
        },
        sprinter: {
            base: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(-20 32 32)"><path d="M32 34 C 42 28, 50 32, 50 38 L 46 52 L 18 52 L 14 38 C 14 32, 22 28, 32 34" fill="#a855f7"/><path d="M32,22 a6,6 0 1,1 0,12 a6,6 0 1,1 0,-12" fill="#d1d5db"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/></g></svg>`,
            surge: `<svg viewBox="0 0 64 64"><g transform="translate(0, 4) rotate(-25 32 32)"><path d="M32 34 C 42 28, 50 32, 50 38 L 46 52 L 18 52 L 14 38 C 14 32, 22 28, 32 34" fill="#9333ea"/><path d="M32,22 a6,6 0 1,1 0,12 a6,6 0 1,1 0,-12" fill="#f9fafb"/><circle cx="20" cy="56" r="6" fill="#1f2937" stroke="#a855f7" stroke-width="2"/><circle cx="44" cy="56" r="6" fill="#1f2937" stroke="#a855f7" stroke-width="2"/></g></svg>`
        }
    };
    function createSvgImage(svgString) {
        const img = new Image();
        const blob = new Blob([svgString], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        img.src = url;
        img.onload = () => URL.revokeObjectURL(url);
        return img;
    }

    // --- Audio Generation ---
    const sounds = {
        draftIn: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 } }).toDestination(),
        draftOut: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(),
        rouleurSurge: new Tone.MembraneSynth({ pitchDecay: 0.08, octaves: 2, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.8, sustain: 0.1, release: 1.2 } }).toDestination(),
        climberSurge: new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination(),
        sprinterSurge: new Tone.MetalSynth({ frequency: 150, envelope: { attack: 0.001, decay: 0.3, release: 0.1 }, harmonicity: 8.1, modulationIndex: 40, resonance: 2000, octaves: 1.5 }).toDestination(),
        wind: new Tone.NoiseSynth({ noise: { type: "brown" }, envelope: { attack: 0.5, decay: 0.1, sustain: 1, release: 0.5 } }).toDestination(),
    };
    sounds.wind.volume.value = -25;
    
    // --- Sprite Loading ---
    const heroSprite = { base: createSvgImage(SVG_ASSETS.hero.base), surge: createSvgImage(SVG_ASSETS.hero.surge) };
    const villainSprites = {
      rouleur: { base: createSvgImage(SVG_ASSETS.rouleur.base), surge: createSvgImage(SVG_ASSETS.rouleur.surge) },
      climber: { base: createSvgImage(SVG_ASSETS.climber.base), surge: createSvgImage(SVG_ASSETS.climber.surge) },
      sprinter: { base: createSvgImage(SVG_ASSETS.sprinter.base), surge: createSvgImage(SVG_ASSETS.sprinter.surge) }
    };
    
    // --- Physics & Game constants ---
    const MASS=79.4,GRAVITY=9.81,RHO=1.225,CDA=0.32,CRR=0.004,EFF=0.97,MS2KMH=3.6;
    const DRAFT_GAP=2.0, DRAFT_BENEFIT=0.25; // 25% power reduction
    const VILLAIN_DURATIONS = { rouleur:30, climber:20, sprinter:10 };

    // --- State ---
    let running=false, lastTs=0;
    let player={power:180, speed:0, pos:0, isSurging: false};
    let villain={active:false, type:null, power:0, speed:0, pos:5, timeLeft:0, isSurging: false, surgeCooldown: 0};
    let score=0, wasDrafting=false, roadOffset = 0, currentGrade = 0;
    let backgroundLayers = [
        { offset: 0, speed: 0.05, color: '#1e3a8a' }, // Deep sky
        { offset: 0, speed: 0.1, color: '#374151' }, // Distant mountains
        { offset: 0, speed: 0.25, color: '#4b5563' }, // Closer hills
    ];

    // --- DOM ---
    const powerSlider=document.getElementById("powerSlider");
    const powerOut=document.getElementById("powerOut");
    const speedOut=document.getElementById("speedOut");
    const villName=document.getElementById("villName");
    const gapOut=document.getElementById("gapOut");
    const scoreOut=document.getElementById("scoreOut");
    const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
    const surgeContainer = document.getElementById("surge-container");

    function resizeCanvas() {
        const container = document.getElementById('game-container');
        const aspectRatio = 3 / 1;
        const newWidth = container.clientWidth;
        canvas.width = newWidth;
        canvas.height = newWidth / aspectRatio;
    }
    window.addEventListener('resize', resizeCanvas);

    powerSlider.oninput=()=>{
        player.power=parseInt(powerSlider.value); 
        powerOut.textContent=player.power;
        player.isSurging = player.power > 400;
    };

    document.getElementById("startBtn").onclick = async () => {
        await Tone.start();
        console.log("Audio context started");
        startGame();
    };

    function speedFromPower(power, grade = 0, drafting = false){
      let effectivePower = power;
      if (drafting) effectivePower /= (1 - DRAFT_BENEFIT);
      if(effectivePower <= 1) return 0;
      
      // Equation for power from speed v: P*eff = (F_roll + F_grav)*v + F_drag*v
      function requiredPower(v){
          const Froll = CRR * MASS * GRAVITY * Math.cos(Math.atan(grade));
          const Fgrav = MASS * GRAVITY * Math.sin(Math.atan(grade));
          const Fdrag = 0.5 * RHO * CDA * v * v;
          return (Froll + Fgrav + Fdrag) * v;
      }
      
      let lo = 0, hi = 25, mid;
      for(let i = 0; i < 25; i++){
          mid = (lo + hi) / 2;
          if(requiredPower(mid) > effectivePower * EFF) hi = mid;
          else lo = mid;
      }
      return mid;
    }

    function startGame(){
      if (running) { // Handle restart
          sounds.wind.triggerRelease();
      }
      running=true; lastTs=performance.now();
      player={power:parseInt(powerSlider.value),speed:0,pos:0, isSurging: player.power > 400};
      score=0; wasDrafting=false; roadOffset = 0; currentGrade = 0;
      villain={active:false}; // Clear old villain
      spawnVillain();
      sounds.wind.triggerAttack();
      requestAnimationFrame(tick);
    }

    function spawnVillain(){
      const types=["rouleur", "climber", "sprinter"];
      const type=types[Math.floor(Math.random() * types.length)];
      villain={
          active:true, type:type, power:300, speed:0, 
          pos:player.pos+10, timeLeft:VILLAIN_DURATIONS[type], 
          isSurging: false, surgeCooldown: 2 + Math.random() * 3
      };
      villName.textContent = type.charAt(0).toUpperCase() + type.slice(1);
    }

    function endVillain(){
      villain.active=false;
      villain.type=null;
      villName.textContent="None";
      const wait=1000*(10+Math.random()*20);
      setTimeout(()=>{ if(running && !villain.active) spawnVillain(); },wait);
    }
    
    function triggerSurgeEffect() {
        const surgeEl = document.createElement('div');
        surgeEl.className = 'surge-effect';
        surgeContainer.appendChild(surgeEl);
        setTimeout(() => surgeEl.remove(), 400);
    }

    function updateVillain(dt) {
        if (!villain.active) return;
        villain.timeLeft -= dt;
        villain.surgeCooldown -= dt;

        let basePower = 300;
        // Type-specific logic
        if (villain.type === 'climber') {
            basePower = 250 + 2000 * currentGrade;
        } else if (villain.type === 'rouleur') {
            basePower = 350;
        } else if (villain.type === 'sprinter') {
            basePower = 200;
        }

        villain.power = basePower;
        villain.isSurging = false;

        if (villain.surgeCooldown <= 0) {
            villain.isSurging = true;
            let surgePower = 200;
            if (villain.type === 'climber') {
                surgePower = 250;
                sounds.climberSurge.triggerAttackRelease("C2", "0.5s");
            } else if (villain.type === 'rouleur') {
                surgePower = 150;
                sounds.rouleurSurge.triggerAttackRelease("C1", "1.2s");
            } else if (villain.type === 'sprinter') {
                surgePower = 600;
                sounds.sprinterSurge.triggerAttackRelease("now");
            }
            villain.power += surgePower;
            villain.surgeCooldown = 5 + Math.random() * 5; // Reset cooldown
            triggerSurgeEffect();
        }
    }


    function tick(ts){
      if(!running)return;
      const dt=Math.min(0.05,(ts-lastTs)/1000); lastTs=ts;
        

      // --- Update state ---
      currentGrade = Math.sin(player.pos / 150) * 0.05; // Gentle rolling hills grade
      
      const drafting = villain.active && (villain.pos - player.pos > 0) && (villain.pos - player.pos < DRAFT_GAP);
      
      if(drafting && !wasDrafting) sounds.draftIn.triggerAttackRelease("C5", "0.2s");
      if(!drafting && wasDrafting) sounds.draftOut.triggerAttackRelease("C3", "0.1s");
      wasDrafting = drafting;

      if(drafting) score += dt * 10;
      score += dt; // Base score for riding

      player.speed = speedFromPower(player.power, currentGrade, drafting);
      player.pos += player.speed * dt;
      
      if(villain.active){
        updateVillain(dt);
        villain.speed = speedFromPower(villain.power, currentGrade, false);
        villain.pos += villain.speed * dt;
        if(villain.timeLeft <= 0) { endVillain(); }
      }
      
      roadOffset = (roadOffset + player.speed * dt * 2) % 100; // Speed of road lines
      backgroundLayers.forEach(layer => {
          layer.offset = (layer.offset + player.speed * dt * layer.speed) % canvas.width;
      });

      // --- Update UI ---
      speedOut.textContent=(player.speed*MS2KMH).toFixed(1);
      const gap = villain.active ? villain.pos - player.pos : Infinity;
      gapOut.textContent = isFinite(gap) ? gap.toFixed(1) + " m" : "â€”";
      scoreOut.textContent=Math.floor(score);
      sounds.wind.volume.value = -30 + Math.min(20, player.speed); // Wind sound scales with speed

      // --- Render ---
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const w = canvas.width, h = canvas.height;

      // Draw Parallax Background
      ctx.fillStyle = '#0f172a'; // Night Sky
      ctx.fillRect(0, 0, w, h);
      backgroundLayers.forEach(layer => {
          ctx.fillStyle = layer.color;
          const hillHeight = h * 0.5;
          for(let i = 0; i < w + 200; i+=100){
            ctx.beginPath();
            ctx.moveTo(i-layer.offset, h);
            ctx.bezierCurveTo(i-layer.offset+25, h-hillHeight, i-layer.offset+75, h-hillHeight, i-layer.offset+100, h);
            ctx.fill();
          }
      });
      
      // Draw Road
      ctx.fillStyle = '#1e293b'; // Road color
      ctx.beginPath();
      ctx.moveTo(0, h * 0.7);
      ctx.lineTo(w, h * 0.7);
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.fill();
      
      // Draw Road Lines
      ctx.strokeStyle = '#f59e0b';
      ctx.lineWidth = 4;
      ctx.setLineDash([40, 60]);
      ctx.lineDashOffset = -roadOffset;
      ctx.beginPath();
      ctx.moveTo(0, h * 0.85);
      ctx.lineTo(w, h * 0.85);
      ctx.stroke();
      ctx.setLineDash([]); // Reset for other drawing

      // Draw Characters
      const baseY = h * 0.7;
      const playerX = w * 0.3;
      const playerY = baseY - 64 + Math.sin(player.pos / (Math.PI/2)) * 3; // Bobbing motion
      const playerSprite = player.isSurging ? heroSprite.surge : heroSprite.base;
    //   ctx.drawImage(playerSprite, playerX - 32, playerY, 64, 64);

      
    if (!playerSprite && playerSprite.complete)return; // Wait for sprite load
    if (!villainSprites.rouleur.base.complete || !villainSprites.climber.base.complete || !villainSprites.sprinter.base.complete) return;

    if (playerSprite && playerSprite.complete && !playerSprite.naturalWidth === 0) {
        ctx.drawImage(playerSprite, playerX - 32, playerY, 64, 64);
    };
      
      if(villain.active){
        const villainX = playerX + gap * 20; // Scale gap for visual distance
        if(villainX < w + 100) { // Only draw if on screen
            const villainY = baseY - 64 + Math.sin(villain.pos / (Math.PI/2)) * 3;
            const villainSprite = villain.isSurging ? villainSprites[villain.type].surge : villainSprites[villain.type].base;
            
            // Draw drafting aura
            if (drafting) {
                const auraX = villainX;
                const auraY = villainY + 32;
                const gradient = ctx.createRadialGradient(auraX, auraY, 5, auraX, auraY, 40);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(auraX - 40, auraY - 40, 80, 80);
            }
            

            if (villainSprite && villainSprite.complete && !villainSprite.naturalWidth === 0) {

                // Draw villain
            ctx.drawImage(villainSprite, villainX - 32, villainY, 64, 64);

            }

            
        }
      }

      requestAnimationFrame(tick);
    }
    
    // Initial setup
    resizeCanvas();
  </script>
</body>
</html>

